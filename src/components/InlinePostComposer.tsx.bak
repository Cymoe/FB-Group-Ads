import { useState, useEffect, useRef } from 'react'
import { Plus, X, Send, Edit, AlertTriangle } from 'lucide-react'
import toast from 'react-hot-toast'
import { List } from 'react-window'
import type { Company, Group, Post } from '../types/database'
import { calculateGroupHealth } from '../utils/groupHealth'
import { aiTemplateStructure } from './aiTemplates'

interface InlinePostComposerProps {
  companies: Company[]
  groups: Group[]
  selectedCompanyId: string | null
  selectedGroupId?: string | null
  editingPost?: Post | null
  onPostCreated: (post: any, showToast?: boolean) => Promise<any>
  onPostUpdated?: (id: string, updates: any) => void
  onCancelEdit?: () => void
  onClose?: () => void
  isDarkMode?: boolean
  isRecentPostsCollapsed?: boolean
}

const postTypes = [
  { value: 'value_post', label: 'Value Post', icon: 'üí°', description: 'Helpful tips and value' },
  { value: 'cost_saver', label: 'Cost Saver', icon: 'üí∞', description: 'Money-saving tips' },
  { value: 'quick_tip', label: 'Quick Tip', icon: '‚ö°', description: 'Brief, actionable advice' },
  { value: 'warning_post', label: 'Warning', icon: '‚ö†Ô∏è', description: 'Important alerts' },
  { value: 'local_alert', label: 'Local Alert', icon: 'üö®', description: 'Location-specific info' },
  { value: 'myth_buster', label: 'Myth Buster', icon: 'üîç', description: 'Debunk misconceptions' },
  { value: 'diy_guide', label: 'DIY Guide', icon: 'üîß', description: 'Simple DIY tips' },
  { value: 'personal_story', label: 'Personal Story', icon: 'üë§', description: 'Share experiences' },
  { value: 'community_intro', label: 'Community Intro', icon: 'üëã', description: 'Introduce yourself' },
  { value: 'behind_scenes', label: 'Behind Scenes', icon: 'üé¨', description: 'Show authenticity' },
  { value: 'special_offer', label: 'Special Offer', icon: 'üéÅ', description: 'Limited promotions' },
  { value: 'feature_friday', label: 'Feature Friday', icon: 'üéâ', description: 'Weekly highlights' }
]

export default function InlinePostComposer({ 
  companies, 
  groups, 
  selectedCompanyId,
  selectedGroupId,
  editingPost,
  onPostCreated,
  onPostUpdated,
  onCancelEdit,
  isDarkMode = true,
  isRecentPostsCollapsed = false
}: InlinePostComposerProps) {
  const composerRef = useRef<HTMLDivElement>(null)
  const [isExpanded, setIsExpanded] = useState(false)
  const [content, setContent] = useState('')
  const [title, setTitle] = useState('')
  const [selectedPostType, setSelectedPostType] = useState('value_post')
  const [showPostTypeSelector, setShowPostTypeSelector] = useState(false)
  const [showPreview, setShowPreview] = useState(false)
  const [isGenerating, setIsGenerating] = useState(false)
  const [showDuplicateModal, setShowDuplicateModal] = useState(false)
  const [createdPost, setCreatedPost] = useState<any>(null)
  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])
  const [isDuplicating, setIsDuplicating] = useState(false)
  
  // Undo functionality for bulk operations
  const [recentBulkPosts, setRecentBulkPosts] = useState<Array<{ id: string, groupName: string }>>([])
  const [showUndoBanner, setShowUndoBanner] = useState(false)
  const [isUndoing, setIsUndoing] = useState(false)
  const undoTimerRef = useRef<NodeJS.Timeout | null>(null)
  
  // AI Generation
  const [isGeneratingAI, setIsGeneratingAI] = useState(false)
  const [showAIPrompts, setShowAIPrompts] = useState(false)
  const [selectedIndustry, setSelectedIndustry] = useState<string | null>(null)
  const [selectedServiceType, setSelectedServiceType] = useState<string | null>(null)
  const [selectedGoal, setSelectedGoal] = useState<string | null>(null)
  
  const isEditMode = !!editingPost

  // AI Template Structure is now imported from ./aiTemplates.ts
  
  // Auto-suggest post type based on content
  const suggestPostType = (text: string) => {
    const lowerText = text.toLowerCase()
    if (lowerText.includes('save') || lowerText.includes('money') || lowerText.includes('cost')) return 'cost_saver'
            { id: 'book_discount', name: 'Book Now Discount', icon: 'üí∞', prompt: 'Generate a Facebook post with a limited-time booking discount. Include: discount percentage/amount, what services are included, deadline for booking, scarcity messaging, clear booking CTA. Company: {company}' },
            { id: 'quiz_lead', name: 'Quiz/Assessment', icon: 'üìù', prompt: 'Generate a Facebook post with a quiz or assessment to generate leads. Include: engaging question about home condition, multiple choice answers, promise of personalized recommendations, CTA to take quiz. Company: {company}' }
          ]
        },
        education: {
          name: 'Educational Content',
          icon: 'üéì',
          templates: [
            { id: 'diy_tips', name: 'DIY Tips', icon: 'üîß', prompt: 'Generate a Facebook post with helpful DIY tips for homeowners. Include: 3-5 actionable tips, clear numbered list, warnings about when to call a pro, friendly educational tone. Company: {company}' },
            { id: 'common_mistakes', name: 'Common Mistakes', icon: '‚ö†Ô∏è', prompt: 'Generate a Facebook post about common homeowner mistakes. Include: 3-5 mistakes people make, why each is problematic, how to avoid them, CTA to contact for help. Company: {company}' },
            { id: 'seasonal_prep', name: 'Seasonal Preparation', icon: 'üçÇ', prompt: 'Generate a Facebook post about seasonal home preparation. Include: season-specific checklist, why each item matters, consequences of neglecting maintenance, offer to help. Company: {company}' },
            { id: 'how_it_works', name: 'How It Works', icon: '‚öôÔ∏è', prompt: 'Generate an educational Facebook post explaining how home systems work. Include: simple explanation of the system, common issues, maintenance tips, when to call a professional. Company: {company}' }
          ]
        },
        promotions: {
          name: 'Promotions & Offers',
          icon: 'üéÅ',
          templates: [
            { id: 'seasonal_deal', name: 'Seasonal Deal', icon: 'üåü', prompt: 'Generate a Facebook post for a seasonal promotion. Include: seasonal relevance, discount details, what services are included, deadline, urgency messaging, booking CTA. Company: {company}' },
            { id: 'referral_program', name: 'Referral Program', icon: 'üë•', prompt: 'Generate a Facebook post about a customer referral program. Include: referral reward details, how it works, benefits for both parties, CTA to refer. Company: {company}' },
            { id: 'bundle_offer', name: 'Service Bundle', icon: 'üì¶', prompt: 'Generate a Facebook post for a bundled service offer. Include: what services are included, total savings, why bundling makes sense, limited availability, booking CTA. Company: {company}' }
          ]
        },
        social_proof: {
          name: 'Social Proof',
          icon: '‚≠ê',
          templates: [
            { id: 'before_after', name: 'Before/After', icon: 'üì∏', prompt: 'Generate a Facebook post showcasing a before/after transformation. Include: the problem faced, solution provided, impressive results, customer satisfaction hint, CTA to get similar results. Company: {company}' },
            { id: 'testimonial', name: 'Customer Testimonial', icon: 'üí¨', prompt: 'Generate a Facebook post featuring a customer testimonial. Include: customer quote, specific problem solved, results achieved, gratitude, CTA for others to get help. Company: {company}' },
            { id: 'milestone', name: 'Company Milestone', icon: 'üèÜ', prompt: 'Generate a Facebook post celebrating a company milestone. Include: the achievement, thank you to customers, what it means for service quality, continued commitment, CTA. Company: {company}' }
          ]
        }
      }
    },
    real_estate: {
      name: 'Real Estate',
      icon: 'üè°',
      description: 'Agents, Brokers, Property Management',
      goals: {
        listings: {
          name: 'Property Listings',
          icon: 'üèòÔ∏è',
          templates: [
            { id: 'new_listing', name: 'New Listing Announcement', icon: 'üÜï', prompt: 'Generate a Facebook post announcing a new property listing. Include: key property features, location highlights, price range, standout amenities, viewing CTA. Company: {company}' },
            { id: 'open_house', name: 'Open House Invite', icon: 'üö™', prompt: 'Generate a Facebook post inviting people to an open house. Include: date/time, property highlights, what to expect, RSVP details, urgency to attend. Company: {company}' },
            { id: 'price_reduction', name: 'Price Reduction', icon: 'üí∞', prompt: 'Generate a Facebook post announcing a price reduction. Include: new price, motivation to act now, property highlights, viewing availability, quick action CTA. Company: {company}' }
          ]
        },
        market_insights: {
          name: 'Market Insights',
          icon: 'üìä',
          templates: [
            { id: 'market_update', name: 'Market Update', icon: 'üìà', prompt: 'Generate a Facebook post about local real estate market trends. Include: current market snapshot, what it means for buyers/sellers, expert analysis, consultation CTA. Company: {company}' },
            { id: 'neighborhood_spotlight', name: 'Neighborhood Spotlight', icon: 'üåÜ', prompt: 'Generate a Facebook post highlighting a specific neighborhood. Include: area features, recent sales data, lifestyle appeal, local amenities, inquiry CTA. Company: {company}' },
            { id: 'buying_tips', name: 'Buying/Selling Tips', icon: 'üí°', prompt: 'Generate a Facebook post with tips for buyers or sellers. Include: 3-5 actionable tips, why each matters, common mistakes to avoid, offer to help. Company: {company}' }
          ]
        }
      }
    },
    contractors: {
      name: 'Contractors',
      icon: 'üî®',
      description: 'Construction, Remodeling, General Contracting',
      goals: {
        project_showcase: {
          name: 'Project Showcase',
          icon: 'üèóÔ∏è',
          templates: [
            { id: 'completed_project', name: 'Completed Project', icon: '‚úÖ', prompt: 'Generate a Facebook post showcasing a completed project. Include: project scope, challenges overcome, final results, craftsmanship highlights, inquiry CTA. Company: {company}' },
            { id: 'in_progress', name: 'Work in Progress', icon: 'üöß', prompt: 'Generate a Facebook post showing work in progress. Include: what\'s being built, interesting details, timeline update, behind-the-scenes appeal, follow for updates. Company: {company}' }
          ]
        },
        expertise: {
          name: 'Expertise & Trust',
          icon: 'üéØ',
          templates: [
            { id: 'process_explanation', name: 'Our Process', icon: 'üìã', prompt: 'Generate a Facebook post explaining your construction/remodeling process. Include: step-by-step overview, quality assurance, communication approach, why it matters, consultation CTA. Company: {company}' },
            { id: 'materials_quality', name: 'Quality Materials', icon: 'üèÖ', prompt: 'Generate a Facebook post about the quality materials you use. Include: specific materials/brands, why quality matters, long-term benefits, warranty info, project inquiry CTA. Company: {company}' }
          ]
        }
      }
    },
    local_business: {
      name: 'Local Business',
      icon: 'üè™',
      description: 'Restaurants, Retail, Services',
      goals: {
        engagement: {
          name: 'Community Engagement',
          icon: 'üëã',
          templates: [
            { id: 'behind_scenes', name: 'Behind the Scenes', icon: 'üé¨', prompt: 'Generate a Facebook post showing behind-the-scenes of your business. Include: interesting process, team member spotlight, authenticity, what makes you special, visit CTA. Company: {company}' },
            { id: 'local_partnership', name: 'Local Partnership', icon: 'ü§ù', prompt: 'Generate a Facebook post about a local partnership or community involvement. Include: who you\'re partnering with, shared values, community benefit, supporting local, visit CTA. Company: {company}' }
          ]
        },
        offers: {
          name: 'Deals & Offers',
          icon: 'üéâ',
          templates: [
            { id: 'daily_special', name: 'Daily Special', icon: '‚≠ê', prompt: 'Generate a Facebook post about a daily special or featured item. Include: what\'s special today, why it\'s great, limited availability, urgency, visit/order CTA. Company: {company}' },
            { id: 'loyalty_reward', name: 'Loyalty Program', icon: 'üíé', prompt: 'Generate a Facebook post promoting your loyalty/rewards program. Include: how it works, benefits/rewards, easy sign-up, example savings, join CTA. Company: {company}' }
          ]
        }
      }
    },
    auto_services: {
      name: 'Auto Services',
      icon: 'üöó',
      description: 'Mechanics, Detailing, Body Shops, Tire Services',
      goals: {
        lead_gen: {
          name: 'Lead Generation',
          icon: 'üìà',
          templates: [
            { id: 'free_inspection', name: 'Free Vehicle Inspection', icon: 'üîç', prompt: 'Generate a Facebook post offering a FREE vehicle inspection. Include: common car problems to catch early, what the inspection covers, limited-time offer, peace of mind benefit, booking CTA. Company: {company}' },
            { id: 'seasonal_service', name: 'Seasonal Service Special', icon: 'üçÇ', prompt: 'Generate a Facebook post for seasonal auto service. Include: why this season matters for car maintenance, specific services offered, discount details, consequences of skipping maintenance, booking CTA. Company: {company}' },
            { id: 'new_customer', name: 'New Customer Discount', icon: 'üéÅ', prompt: 'Generate a Facebook post welcoming new customers with a discount. Include: discount amount, services included, first-time trust-building, why choose us, easy booking CTA. Company: {company}' }
          ]
        },
        education: {
          name: 'Car Care Tips',
          icon: 'üéì',
          templates: [
            { id: 'warning_signs', name: 'Warning Signs', icon: '‚ö†Ô∏è', prompt: 'Generate a Facebook post about car warning signs to watch for. Include: 3-5 specific warning signs, what each means, risks of ignoring them, when to bring it in, service CTA. Company: {company}' },
            { id: 'maintenance_schedule', name: 'Maintenance Schedule', icon: 'üìÖ', prompt: 'Generate a Facebook post about vehicle maintenance schedules. Include: key mileage milestones, what should be done at each, why it matters, consequences of skipping, schedule appointment CTA. Company: {company}' },
            { id: 'diy_vs_pro', name: 'DIY vs Professional', icon: 'üîß', prompt: 'Generate a Facebook post about what car maintenance you can DIY vs when to see a pro. Include: safe DIY tasks, when to get professional help, cost of mistakes, expertise benefits, consultation CTA. Company: {company}' }
          ]
        },
        trust_building: {
          name: 'Build Trust',
          icon: '‚≠ê',
          templates: [
            { id: 'certifications', name: 'Certifications & Expertise', icon: 'üèÖ', prompt: 'Generate a Facebook post highlighting your certifications and expertise. Include: specific certifications, years of experience, specialized training, what it means for customers, service inquiry CTA. Company: {company}' },
            { id: 'customer_story', name: 'Customer Success Story', icon: 'üí¨', prompt: 'Generate a Facebook post sharing a customer success story. Include: the car problem, diagnosis and solution, customer relief/satisfaction, quality of work, CTA for similar help. Company: {company}' }
          ]
        }
      }
    },
    health_wellness: {
      name: 'Health & Wellness',
      icon: 'üí™',
      description: 'Gyms, Trainers, Chiropractors, Yoga, Nutrition',
      goals: {
        lead_gen: {
          name: 'Lead Generation',
          icon: 'üìà',
          templates: [
            { id: 'free_trial', name: 'Free Trial/Class', icon: 'üé´', prompt: 'Generate a Facebook post offering a free trial class or session. Include: what they\'ll experience, no commitment messaging, beginner-friendly emphasis, limited spots, easy sign-up CTA. Company: {company}' },
            { id: 'transformation_challenge', name: 'Transformation Challenge', icon: 'üèÜ', prompt: 'Generate a Facebook post for a fitness/wellness challenge. Include: challenge duration, what\'s included, support provided, potential results, limited spots, join CTA. Company: {company}' },
            { id: 'consultation_offer', name: 'Free Consultation', icon: 'üí¨', prompt: 'Generate a Facebook post offering a free consultation or assessment. Include: what you\'ll discover, personalized approach, no pressure messaging, expertise highlight, booking CTA. Company: {company}' }
          ]
        },
        education: {
          name: 'Health Education',
          icon: 'üéì',
          templates: [
            { id: 'common_mistakes', name: 'Common Fitness Mistakes', icon: '‚ö†Ô∏è', prompt: 'Generate a Facebook post about common fitness/health mistakes. Include: 3-5 mistakes people make, why each is problematic, how to fix them, offer to help properly, CTA. Company: {company}' },
            { id: 'myth_buster', name: 'Health Myth Buster', icon: 'üîç', prompt: 'Generate a Facebook post debunking a common health/fitness myth. Include: the myth, why it\'s wrong, what actually works, scientific basis, guidance offer CTA. Company: {company}' },
            { id: 'quick_tips', name: 'Quick Health Tips', icon: '‚ö°', prompt: 'Generate a Facebook post with quick actionable health tips. Include: 3-5 easy-to-implement tips, benefits of each, how to start today, encouragement, follow for more. Company: {company}' }
          ]
        },
        motivation: {
          name: 'Motivation & Inspiration',
          icon: 'üåü',
          templates: [
            { id: 'success_story', name: 'Client Success Story', icon: 'üéâ', prompt: 'Generate a Facebook post celebrating a client success story. Include: their journey, obstacles overcome, results achieved, what made the difference, inspiration for others, join CTA. Company: {company}' },
            { id: 'motivational', name: 'Motivational Message', icon: 'üí™', prompt: 'Generate a motivational Facebook post for health/wellness. Include: inspiring message, relatable challenges, encouragement, small steps matter, we\'re here to help CTA. Company: {company}' }
          ]
        }
      }
    },
    professional_services: {
      name: 'Professional Services',
      icon: 'üíº',
      description: 'Lawyers, Insurance, Financial, Accounting',
      goals: {
        lead_gen: {
          name: 'Lead Generation',
          icon: 'üìà',
          templates: [
            { id: 'free_consultation', name: 'Free Consultation', icon: 'üí¨', prompt: 'Generate a Facebook post offering a free consultation. Include: what you\'ll discuss, no obligation messaging, confidential approach, expertise highlight, easy scheduling CTA. Company: {company}' },
            { id: 'free_review', name: 'Free Review/Audit', icon: 'üîç', prompt: 'Generate a Facebook post offering a free review or audit (insurance, financial, legal docs). Include: what you\'ll analyze, potential savings/benefits, no pressure, expertise, booking CTA. Company: {company}' },
            { id: 'webinar_invite', name: 'Educational Webinar', icon: 'üéì', prompt: 'Generate a Facebook post inviting people to an educational webinar. Include: topic/problem addressed, what they\'ll learn, date/time, free attendance, expert host, registration CTA. Company: {company}' }
          ]
        },
        education: {
          name: 'Professional Education',
          icon: 'üìö',
          templates: [
            { id: 'common_mistakes', name: 'Common Mistakes', icon: '‚ö†Ô∏è', prompt: 'Generate a Facebook post about common mistakes people make (legal, financial, insurance). Include: 3-5 costly mistakes, consequences of each, how to avoid them, professional guidance CTA. Company: {company}' },
            { id: 'law_changes', name: 'Law/Regulation Updates', icon: 'üì∞', prompt: 'Generate a Facebook post about recent law or regulation changes. Include: what changed, who it affects, action items, deadline if applicable, consultation CTA. Company: {company}' },
            { id: 'faqs', name: 'FAQ Explainer', icon: '‚ùì', prompt: 'Generate a Facebook post answering common questions in your field. Include: 3-5 frequent questions, clear answers, why it matters, personalized help offer CTA. Company: {company}' }
          ]
        },
        trust_building: {
          name: 'Build Trust',
          icon: '‚≠ê',
          templates: [
            { id: 'case_study', name: 'Case Study (Anonymous)', icon: 'üìä', prompt: 'Generate a Facebook post sharing an anonymous case study. Include: client situation, challenges faced, solution provided, results achieved, how we can help you, consultation CTA. Company: {company}' },
            { id: 'credentials', name: 'Credentials & Experience', icon: 'üèÖ', prompt: 'Generate a Facebook post highlighting credentials and experience. Include: certifications, years in practice, specializations, client successes, why experience matters, inquiry CTA. Company: {company}' }
          ]
        }
      }
    },
    beauty_care: {
      name: 'Beauty & Personal Care',
      icon: 'üíÖ',
      description: 'Salons, Barbers, Spas, Estheticians',
      goals: {
        lead_gen: {
          name: 'Lead Generation',
          icon: 'üìà',
          templates: [
            { id: 'new_client_special', name: 'New Client Special', icon: 'üéÅ', prompt: 'Generate a Facebook post with a new client special offer. Include: discount amount, services included, first-time experience emphasis, limited time, easy booking CTA. Company: {company}' },
            { id: 'seasonal_service', name: 'Seasonal Service', icon: 'üçÇ', prompt: 'Generate a Facebook post for a seasonal beauty service. Include: why this service is perfect for the season, benefits, special pricing, limited availability, booking CTA. Company: {company}' },
            { id: 'package_deal', name: 'Service Package', icon: 'üì¶', prompt: 'Generate a Facebook post for a service package deal. Include: services included, total value vs price, why bundle makes sense, limited offer, booking CTA. Company: {company}' }
          ]
        },
        education: {
          name: 'Beauty Tips',
          icon: 'üéì',
          templates: [
            { id: 'care_tips', name: 'Care & Maintenance Tips', icon: '‚≠ê', prompt: 'Generate a Facebook post with care tips (hair, skin, nails). Include: 3-5 actionable tips, products to use/avoid, common mistakes, professional service benefits, booking CTA. Company: {company}' },
            { id: 'trend_spotlight', name: 'Trend Spotlight', icon: 'üåü', prompt: 'Generate a Facebook post about current beauty trends. Include: trending style/technique, why it\'s popular, who it\'s great for, book to try it, your expertise CTA. Company: {company}' },
            { id: 'before_after_care', name: 'Before/After Care', icon: 'üìã', prompt: 'Generate a Facebook post about before/after care for services. Include: preparation tips, what to avoid, how to maintain results, why it matters, booking CTA. Company: {company}' }
          ]
        },
        showcase: {
          name: 'Portfolio Showcase',
          icon: 'üì∏',
          templates: [
            { id: 'transformation', name: 'Transformation Showcase', icon: '‚ú®', prompt: 'Generate a Facebook post showcasing a transformation. Include: before/after description, techniques used, client happiness, your expertise, book similar service CTA. Company: {company}' },
            { id: 'stylist_spotlight', name: 'Stylist Spotlight', icon: 'üí´', prompt: 'Generate a Facebook post spotlighting a team member. Include: their specialty, experience, what clients love, fun fact, book with them CTA. Company: {company}' }
          ]
        }
      }
    },
    pet_services: {
      name: 'Pet Services',
      icon: 'üêï',
      description: 'Groomers, Vets, Pet Sitters, Trainers',
      goals: {
        lead_gen: {
          name: 'Lead Generation',
          icon: 'üìà',
          templates: [
            { id: 'new_pet_discount', name: 'New Pet Parent Discount', icon: 'üéÅ', prompt: 'Generate a Facebook post with a new client discount for pet services. Include: discount details, services included, pet-friendly approach, first-time experience, easy booking CTA. Company: {company}' },
            { id: 'free_assessment', name: 'Free Assessment/Consultation', icon: 'üí¨', prompt: 'Generate a Facebook post offering a free pet assessment. Include: what you\'ll evaluate, personalized recommendations, no obligation, expertise highlight, scheduling CTA. Company: {company}' },
            { id: 'seasonal_care', name: 'Seasonal Pet Care', icon: 'üçÇ', prompt: 'Generate a Facebook post about seasonal pet care services. Include: season-specific needs, health benefits, service details, limited-time offer, booking CTA. Company: {company}' }
          ]
        },
        education: {
          name: 'Pet Care Tips',
          icon: 'üéì',
          templates: [
            { id: 'care_tips', name: 'Pet Care Tips', icon: '‚≠ê', prompt: 'Generate a Facebook post with pet care tips. Include: 3-5 actionable tips, why each matters, common mistakes pet owners make, professional help offer CTA. Company: {company}' },
            { id: 'warning_signs', name: 'Health Warning Signs', icon: '‚ö†Ô∏è', prompt: 'Generate a Facebook post about pet health warning signs. Include: 3-5 signs to watch for, what each could indicate, when to seek help, service availability CTA. Company: {company}' },
            { id: 'breed_specific', name: 'Breed-Specific Advice', icon: 'üêæ', prompt: 'Generate a Facebook post with breed-specific care advice. Include: breed characteristics, special needs, common issues, how you can help, consultation CTA. Company: {company}' }
          ]
        },
        engagement: {
          name: 'Pet Community',
          icon: '‚ù§Ô∏è',
          templates: [
            { id: 'pet_of_week', name: 'Pet of the Week', icon: 'üèÜ', prompt: 'Generate a Facebook post featuring a pet client. Include: pet name and personality, cute story or photo description, services they love, tag opportunity, book your pet CTA. Company: {company}' },
            { id: 'pet_holiday', name: 'Pet Holiday/Event', icon: 'üéâ', prompt: 'Generate a Facebook post about a pet-related holiday or event. Include: celebration details, special offer, fun activity ideas, community engagement, service booking CTA. Company: {company}' }
          ]
        }
      }
    }
  }

  // Auto-suggest post type based on content
  const suggestPostType = (text: string) => {
    const lowerText = text.toLowerCase()
    if (lowerText.includes('save') || lowerText.includes('money') || lowerText.includes('cost')) return 'cost_saver'
    if (lowerText.includes('tip') || lowerText.includes('quick')) return 'quick_tip'
    if (lowerText.includes('warning') || lowerText.includes('alert') || lowerText.includes('danger')) return 'warning_post'
    if (lowerText.includes('diy') || lowerText.includes('how to') || lowerText.includes('guide')) return 'diy_guide'
    if (lowerText.includes('story') || lowerText.includes('experience')) return 'personal_story'
    if (lowerText.includes('offer') || lowerText.includes('deal') || lowerText.includes('special')) return 'special_offer'
    return 'value_post'
  }

  // AI Generation Function (Placeholder for OpenAI/Grok/Claude)
  const generatePostContent = async (templateId: string, industryId: string, goalId: string) => {
    const industry = (aiTemplateStructure as any)[industryId]
    if (!industry) return
    
    const goal = (industry.goals as any)[goalId]
    if (!goal) return
    
    const template = goal.templates.find((t: any) => t.id === templateId)
    if (!template) return

    setIsGeneratingAI(true)
    
    try {
      const companyName = companies.find(c => c.id === selectedCompanyId)?.name || 'Your Company'
      const promptWithCompany = template.prompt.replace('{company}', companyName)
      
      // TODO: Replace this with actual AI API call (OpenAI, Grok, Claude, etc.)
      // Example structure for when you connect it:
      /*
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${YOUR_API_KEY}`
        },
        body: JSON.stringify({
          model: 'gpt-4',
          messages: [{
            role: 'user',
            content: promptWithCompany
          }]
        })
      })
      const data = await response.json()
      const generatedContent = data.choices[0].message.content
      */

      // Simulate AI generation delay
      await new Promise(resolve => setTimeout(resolve, 2000))
      
      // Placeholder content (you'll replace this with actual AI response)
      const placeholderContent = `${template.icon} Generated: ${template.name}\n\n[Your AI-generated content will appear here when you connect OpenAI, Grok, or Claude]\n\nIndustry: ${industry.name}\nGoal: ${goal.name}\nTemplate: ${template.name}\n\nPrompt used:\n"${promptWithCompany}"`
      
      setContent(placeholderContent)
      toast.success(`‚ú® Post generated! Edit as needed.`)
      
    } catch (error) {
      console.error('AI generation error:', error)
      toast.error('Failed to generate post. Please try again.')
    } finally {
      setIsGeneratingAI(false)
      setSelectedIndustry(null)
      setSelectedGoal(null)
      setShowAIPrompts(false)
    }
  }
  
  // Reset navigation when closing AI prompts
  const closeAIPrompts = () => {
    setShowAIPrompts(false)
    setSelectedIndustry(null)
    setSelectedGoal(null)
  }

  // Get recommended groups based on post type and company
  // Pre-fill form when editing a post
  useEffect(() => {
    if (editingPost) {
      setIsExpanded(true)
      setContent(editingPost.content || '')
      setTitle(editingPost.title || '')
      setSelectedPostType(editingPost.post_type)
      
      // Scroll to composer
      if (composerRef.current) {
        composerRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' })
      }
    }
  }, [editingPost])

  // Auto-suggest groups when post type changes (only in create mode)
  // Auto-recommendation removed - posts go to the currently selected group only

  // Auto-suggest post type when content changes (only in create mode)
  useEffect(() => {
    if (!isEditMode && content.length > 20) {
      const suggested = suggestPostType(content)
      setSelectedPostType(suggested)
    }
  }, [content, isEditMode])

  // Cleanup undo timer on unmount
  useEffect(() => {
    return () => {
      if (undoTimerRef.current) {
        clearTimeout(undoTimerRef.current)
      }
    }
  }, [])

  // Start undo timer (30 seconds)
  const startUndoTimer = (posts: Array<{ id: string, groupName: string }>) => {
    setRecentBulkPosts(posts)
    setShowUndoBanner(true)
    
    // Clear any existing timer
    if (undoTimerRef.current) {
      clearTimeout(undoTimerRef.current)
    }
    
    // Hide banner after 30 seconds
    undoTimerRef.current = setTimeout(() => {
      setShowUndoBanner(false)
      setRecentBulkPosts([])
    }, 30000)
  }

  // Handle bulk undo
  const handleBulkUndo = async () => {
    if (recentBulkPosts.length === 0 || isUndoing) return
    
    setIsUndoing(true)
    const count = recentBulkPosts.length
    let deletedCount = 0
    
    try {
      for (const post of recentBulkPosts) {
        try {
          const response = await fetch(`http://localhost:3001/api/posts/${post.id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            }
          })
          if (response.ok) deletedCount++
        } catch (error) {
          console.error(`Failed to delete post from ${post.groupName}:`, error)
        }
      }
      
      if (deletedCount === count) {
        toast.success(`üéâ Undone! Deleted ${count} post${count !== 1 ? 's' : ''}`)
      } else if (deletedCount > 0) {
        toast.success(`‚ö†Ô∏è Deleted ${deletedCount}/${count} posts`)
      } else {
        toast.error('Failed to undo posts. Please delete manually.')
      }
      
      // Force refresh by reloading the page
      window.location.reload()
    } catch (error) {
      toast.error('Failed to undo. Please try again.')
    } finally {
      setIsUndoing(false)
      setShowUndoBanner(false)
      setRecentBulkPosts([])
      if (undoTimerRef.current) {
        clearTimeout(undoTimerRef.current)
      }
    }
  }

  const handleSavePost = async () => {
    if (!content.trim() || !selectedGroupId) return

    setIsGenerating(true)
    
    try {
      if (isEditMode && editingPost && onPostUpdated) {
        // Update existing post
        const updates = {
          title: title.trim() || content.substring(0, 50) + '...',
          content: content.trim(),
          post_type: selectedPostType,
          group_id: selectedGroupId // Keep the same group
        }
        
        await onPostUpdated(editingPost.id, updates)
        
        // Reset form
        setContent('')
        setTitle('')
        setIsExpanded(false)
        
        if (onCancelEdit) onCancelEdit()
      } else {
        // Create new post for the current group
        if (!selectedGroupId) {
          console.error('No group selected')
          return
        }

        const newPost = {
          company_id: selectedCompanyId,
          group_id: selectedGroupId,
          post_type: selectedPostType,
          title: title.trim() || content.substring(0, 50) + '...',
          content: content.trim(),
          status: 'draft',
          created_at: new Date().toISOString()
        }

        // Create post
        onPostCreated(newPost)
        
        // Store created post and show duplicate modal
        setCreatedPost(newPost)
        setShowDuplicateModal(true)

        // Reset form
        setContent('')
        setTitle('')
        setIsExpanded(false)
      }
      
    } catch (error) {
      console.error('Error saving post:', error)
    } finally {
      setIsGenerating(false)
    }
  }
  
  const handleCancel = () => {
    setContent('')
    setTitle('')
    setIsExpanded(false)
    if (isEditMode && onCancelEdit) {
      onCancelEdit()
    }
  }


  const selectedCompany = companies?.find(c => c.id === selectedCompanyId)
  const selectedPostTypeInfo = postTypes.find(p => p.value === selectedPostType)

  if (!selectedCompanyId) {
    return (
      <div className="rounded p-4 mb-4" style={{ backgroundColor: 'var(--card-bg)', border: '1px solid var(--border-neutral)' }}>
        <div className="text-center py-6">
          <div className="w-12 h-12 bg-[#336699] rounded-full flex items-center justify-center mx-auto mb-3">
            <Plus size={20} className="text-white" />
          </div>
          <h3 className="font-medium mb-1" style={{ color: 'var(--text-primary)' }}>Select a Company First</h3>
          <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>Choose a company from the sidebar to start creating posts</p>
        </div>
      </div>
    )
  }

  return (
    <div ref={composerRef} className="rounded mb-4" style={{ backgroundColor: 'var(--card-bg)', border: '1px solid var(--border-neutral)' }}>
      {/* Collapsed State */}
      {!isExpanded && (
        <div className="p-4">
          <div className="flex items-center gap-3">
            <button
              onClick={() => setIsExpanded(true)}
              className="w-8 h-8 bg-[#336699] rounded-full flex items-center justify-center transition-all hover:bg-[#336699]/80 cursor-pointer"
              title="Create new post"
            >
              <Plus size={16} className="text-white" />
            </button>
            <input
              type="text"
              placeholder={`What's on your mind, ${selectedCompany?.name}? Start typing to create a post...`}
              className="flex-1 border-none outline-none text-sm"
              style={{ 
                backgroundColor: 'var(--post-composer-bg)', 
                color: 'var(--post-composer-text)',
                border: '1px solid var(--post-composer-border)',
                borderRadius: '8px',
                padding: '12px'
              }}
              onFocus={() => setIsExpanded(true)}
              value={content}
              onChange={(e) => setContent(e.target.value)}
            />
          </div>
        </div>
      )}

      {/* Expanded State */}
      {isExpanded && (
        <div className="p-4">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <button
                onClick={handleCancel}
                className="w-8 h-8 bg-[#336699] rounded-full flex items-center justify-center transition-all hover:bg-[#336699]/80"
                title="Close composer"
              >
                {isEditMode ? <Edit size={16} className="text-white" /> : <X size={16} className="text-white" />}
              </button>
              <div>
                <h3 className="font-medium text-sm" style={{ color: 'var(--text-primary)' }}>
                  {isEditMode ? 'Edit Post' : 'Create New Post'}
                </h3>
                <p className="text-xs" style={{ color: 'var(--text-secondary)' }}>for {selectedCompany?.name}</p>
              </div>
            </div>
          </div>

          {/* Split Layout: AI on Left, Form on Right */}
          <div className={showAIPrompts ? "flex gap-6" : "space-y-4"}>

              {/* LEFT COLUMN: AI Generation Section (Only show when creating new posts) */}
              {!isEditMode && !content && (
                <div className={showAIPrompts ? "w-80 flex-shrink-0" : "w-full"}>
                  <div className="rounded-lg p-4 border-2 border-dashed transition-all h-full" style={{ 
                    backgroundColor: 'linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%)',
                    borderColor: 'rgba(59, 130, 246, 0.3)'
                  }}>
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                          <span className="text-white text-sm">‚ú®</span>
                        </div>
                        <div>
                          <h4 className="text-sm font-semibold" style={{ color: 'var(--text-primary)' }}>
                            Generate with AI
                          </h4>
                          <p className="text-xs" style={{ color: 'var(--text-secondary)' }}>
                            {showAIPrompts ? 'Choose a template' : 'Let AI write your post'}
                          </p>
                        </div>
                      </div>
                      {!showAIPrompts && (
            <button
                          onClick={() => setShowAIPrompts(true)}
                          className="px-3 py-1.5 rounded text-xs font-medium transition-all hover:scale-105"
                          style={{ 
                            backgroundColor: '#336699',
                            color: 'white'
                          }}
                        >
                          Get Started ‚Üí
                        </button>
                      )}
                    </div>

                  {/* Multi-Level AI Template Navigation */}
                  {showAIPrompts && (
                    <div className="space-y-3">
                      
                      {/* LEVEL 1: Industry Selection */}
                      {!selectedIndustry && (
                        <>
                          <div className="text-xs font-medium mb-2" style={{ color: 'var(--text-secondary)' }}>
                            Step 1 of 3: Select Your Industry
                          </div>
                          <div className="flex flex-col gap-2">
                            {Object.entries(aiTemplateStructure).map(([key, industry]) => (
                              <button
                                key={key}
                                onClick={() => setSelectedIndustry(key)}
                                className="p-4 rounded-lg text-left transition-all hover:scale-[1.01] hover:border-blue-500"
              style={{ 
                backgroundColor: 'var(--input-bg)', 
                                  border: '1px solid var(--border-neutral)'
                                }}
                              >
                                <div className="flex items-center gap-3 mb-1">
                                  <span className="text-2xl">{industry.icon}</span>
                                  <div className="flex-1">
                                    <div className="text-base font-semibold mb-0.5" style={{ color: 'var(--text-primary)' }}>
                                      {industry.name}
                                    </div>
                                    <p className="text-xs" style={{ color: 'var(--text-secondary)' }}>
                                      {industry.description}
                                    </p>
                                  </div>
                                </div>
                              </button>
                            ))}
                          </div>
                        </>
                      )}

                      {/* LEVEL 2: Goal Selection */}
                      {selectedIndustry && !selectedGoal && (
                        <>
                          <div className="flex items-center justify-between mb-2">
                            <div className="text-xs font-medium" style={{ color: 'var(--text-secondary)' }}>
                              Step 2 of 3: Choose Your Goal
                            </div>
                            <button
                              onClick={() => setSelectedIndustry(null)}
                              className="text-xs px-2 py-1 rounded transition-colors"
                              style={{ 
                                backgroundColor: 'var(--input-bg)',
                color: 'var(--text-secondary)' 
              }}
            >
                              ‚Üê Back
            </button>
          </div>
                          <div className="mb-2 p-2 rounded" style={{ backgroundColor: 'rgba(59, 130, 246, 0.1)' }}>
                            <span className="text-sm font-medium" style={{ color: 'var(--text-primary)' }}>
                              {(aiTemplateStructure as any)[selectedIndustry].icon} {(aiTemplateStructure as any)[selectedIndustry].name}
                            </span>
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            {Object.entries((aiTemplateStructure as any)[selectedIndustry].goals).map(([key, goal]: [string, any]) => (
                              <button
                                key={key}
                                onClick={() => setSelectedGoal(key)}
                                className="p-3 rounded-lg text-left transition-all hover:scale-[1.02] hover:border-blue-500"
                                style={{ 
                                  backgroundColor: 'var(--input-bg)',
                                  border: '1px solid var(--border-neutral)'
                                }}
                              >
                                <div className="flex items-center gap-2">
                                  <span className="text-lg">{goal.icon}</span>
                                  <span className="text-sm font-medium" style={{ color: 'var(--text-primary)' }}>
                                    {goal.name}
                                  </span>
                                </div>
                              </button>
                            ))}
                          </div>
                        </>
                      )}

                      {/* LEVEL 3: Template Selection */}
                      {selectedIndustry && selectedGoal && (
                        <>
                          <div className="flex items-center justify-between mb-2">
                            <div className="text-xs font-medium" style={{ color: 'var(--text-secondary)' }}>
                              Step 3 of 3: Select Template
                            </div>
                            <button
                              onClick={() => setSelectedGoal(null)}
                              className="text-xs px-2 py-1 rounded transition-colors"
                              style={{ 
                                backgroundColor: 'var(--input-bg)',
                                color: 'var(--text-secondary)'
                              }}
                            >
                              ‚Üê Back
                            </button>
                          </div>
                          <div className="mb-2 p-2 rounded flex items-center gap-2" style={{ backgroundColor: 'rgba(59, 130, 246, 0.1)' }}>
                            <span className="text-sm" style={{ color: 'var(--text-primary)' }}>
                              {(aiTemplateStructure as any)[selectedIndustry].icon} {(aiTemplateStructure as any)[selectedIndustry].name}
                            </span>
                            <span style={{ color: 'var(--text-secondary)' }}>‚Üí</span>
                            <span className="text-sm" style={{ color: 'var(--text-primary)' }}>
                              {(aiTemplateStructure as any)[selectedIndustry].goals[selectedGoal].icon} {(aiTemplateStructure as any)[selectedIndustry].goals[selectedGoal].name}
                            </span>
                          </div>
                          <div className="space-y-2 max-h-64 overflow-y-auto">
                            {(aiTemplateStructure as any)[selectedIndustry].goals[selectedGoal].templates.map((template: any) => (
                              <button
                                key={template.id}
                                onClick={() => generatePostContent(template.id, selectedIndustry, selectedGoal)}
                                disabled={isGeneratingAI}
                                className="w-full p-3 rounded-lg text-left transition-all hover:scale-[1.01] hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                style={{ 
                                  backgroundColor: 'var(--input-bg)',
                                  border: '1px solid var(--border-neutral)'
                                }}
                              >
                                <div className="flex items-center gap-2 mb-1">
                                  <span className="text-lg">{template.icon}</span>
                                  <span className="text-sm font-medium" style={{ color: 'var(--text-primary)' }}>
                                    {template.name}
                                  </span>
                                </div>
                                <p className="text-xs line-clamp-2" style={{ color: 'var(--text-secondary)' }}>
                                  {template.prompt.split('.')[0]}...
                                </p>
                              </button>
                            ))}
                          </div>
                        </>
                      )}

                      {/* Loading State */}
                      {isGeneratingAI && (
                        <div className="flex items-center justify-center gap-3 p-4 rounded-lg" style={{ backgroundColor: 'rgba(59, 130, 246, 0.1)' }}>
                          <div className="w-5 h-5 border-2 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div>
                          <span className="text-sm font-medium" style={{ color: 'var(--text-primary)' }}>
                            Generating your post...
                          </span>
                        </div>
                      )}

                      {/* Close AI Prompts */}
                      {!isGeneratingAI && (
                        <button
                          onClick={closeAIPrompts}
                          className="w-full text-xs py-2 rounded transition-colors"
                          style={{ 
                            color: 'var(--text-secondary)',
                            backgroundColor: 'var(--input-bg)'
                          }}
                        >
                          Cancel
                        </button>
                      )}
                    </div>
                  )}
                  </div>
                </div>
              )}

              {/* RIGHT COLUMN: Post Creation Form */}
              <div className={showAIPrompts ? "flex-1 space-y-4" : "w-full space-y-4"}>
                
                {/* Regenerate Button (Show after AI generates content) */}
                {!isEditMode && content && content.includes('[Your AI-generated content') && (
                  <button
                    onClick={() => setShowAIPrompts(true)}
                    className="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all hover:scale-[1.02]"
                    style={{ 
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      border: '1px solid rgba(59, 130, 246, 0.3)',
                      color: '#3B82F6'
                    }}
                  >
                    <span>üîÑ</span>
                    <span>Regenerate with Different Prompt</span>
                  </button>
                )}

              {/* Enhanced Post Type Selector */}
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <span className="text-[11px] font-medium uppercase tracking-[0.5px]" style={{ color: 'var(--text-primary)' }}>Post Type</span>
                  <span className="text-xs" style={{ color: 'var(--text-secondary)' }}>Choose the best format for your content</span>
                </div>
            
            <div className="relative">
              <button
                onClick={() => setShowPostTypeSelector(!showPostTypeSelector)}
                className="w-full flex items-center justify-between px-3 py-2 rounded text-sm transition-colors"
                style={{
                  backgroundColor: 'var(--input-bg)',
                  border: '1px solid var(--input-border)',
                  color: 'var(--text-primary)'
                }}
              >
                <div className="flex items-center gap-2">
                  <span className="text-lg">{selectedPostTypeInfo?.icon}</span>
                  <div className="text-left">
                    <div className="font-medium">{selectedPostTypeInfo?.label}</div>
                    <div className="text-xs" style={{ color: 'var(--text-secondary)' }}>{selectedPostTypeInfo?.description}</div>
                  </div>
                </div>
                <span style={{ color: 'var(--text-secondary)' }}>‚ñº</span>
              </button>

              {/* Enhanced Post Type Dropdown */}
              {showPostTypeSelector && (
                <div className="absolute top-full left-0 right-0 mt-1 rounded shadow-2xl z-50 max-h-80 overflow-y-auto backdrop-blur-sm" style={{ backgroundColor: 'var(--card-bg)', border: '1px solid var(--border-neutral)' }}>
                  <div className="p-2">
                    {postTypes.map(type => (
                      <button
                        key={type.value}
                        onClick={() => {
                          setSelectedPostType(type.value)
                          setShowPostTypeSelector(false)
                        }}
                        className="w-full p-3 rounded text-left transition-colors hover:bg-white/5"
                        style={{
                          backgroundColor: selectedPostType === type.value ? '#336699' : 'transparent',
                          color: selectedPostType === type.value ? 'white' : 'var(--text-primary)'
                        }}
                      >
                        <div className="flex items-center gap-3">
                          <span className="text-lg">{type.icon}</span>
                          <div className="flex-1">
                            <div className="font-medium text-sm">{type.label}</div>
                            <div className="text-xs mt-0.5" style={{ color: selectedPostType === type.value ? 'rgba(255,255,255,0.8)' : 'var(--text-secondary)' }}>{type.description}</div>
                          </div>
                          {selectedPostType === type.value && (
                            <span className="text-xs">‚úì</span>
                          )}
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Title Input */}
          <div>
            <label className="block text-[11px] font-medium uppercase tracking-[0.5px] mb-2" style={{ color: 'var(--text-primary)' }}>Title (optional)</label>
            <input
              type="text"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Enter a compelling title..."
              className="w-full h-10 px-3 rounded text-sm focus:outline-none focus:ring-2 transition-all"
              style={{ 
                backgroundColor: 'var(--input-bg)', 
                borderColor: 'var(--input-border)',
                color: 'var(--text-primary)',
                border: '1px solid var(--input-border)'
              }}
            />
          </div>

          {/* Enhanced Content Input */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <label className="text-[11px] font-medium uppercase tracking-[0.5px]" style={{ color: 'var(--text-primary)' }}>Content</label>
              <div className="flex items-center gap-2">
                <span className="text-xs" style={{ color: content.length > 2000 ? '#dc2626' : content.length > 1500 ? '#f59e0b' : 'var(--text-secondary)' }}>
                  {content.length}/2000
                </span>
                <button
                  onClick={() => setShowPreview(!showPreview)}
                  className="text-xs px-2 py-1 rounded transition-colors"
                  style={{ 
                    backgroundColor: 'var(--input-bg)', 
                    border: '1px solid var(--border-neutral)', 
                    color: 'var(--text-secondary)' 
                  }}
                >
                  {showPreview ? 'Edit' : 'Preview'}
                </button>
              </div>
            </div>
            
            {showPreview ? (
              <div 
                className="rounded p-4" 
                style={{ 
                  backgroundColor: isDarkMode ? '#1E1E1E' : '#F9FAFB', 
                  border: isDarkMode ? '1px solid var(--border-neutral)' : '1px solid #E5E7EB' 
                }}
              >
                <div className="text-xs mb-2" style={{ color: 'var(--text-secondary)' }}>Preview:</div>
                <div className="text-sm whitespace-pre-wrap" style={{ color: 'var(--text-primary)' }}>{content || 'No content to preview...'}</div>
              </div>
            ) : (
              <textarea
                value={content}
                onChange={(e) => setContent(e.target.value)}
                placeholder="Write your post content here..."
                className="w-full min-h-[120px] px-3 py-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#336699]/40 transition-all resize-none"
                style={{
                  backgroundColor: 'var(--input-bg)',
                  border: content.length > 2000 ? '1px solid #dc2626' : content.length > 1500 ? '1px solid #f59e0b' : '1px solid var(--input-border)',
                  color: 'var(--text-primary)'
                }}
              />
            )}
          </div>

          {/* Posting To - Simple info showing current group */}
            <div>
            {selectedGroupId ? (
              <div className="flex items-center gap-2 px-4 py-3 rounded" style={{ backgroundColor: 'var(--input-bg)', border: '1px solid var(--input-border)' }}>
                <span className="text-xs font-medium" style={{ color: 'var(--text-secondary)' }}>
                  Posting to:
                </span>
                <span className="text-sm font-medium" style={{ color: 'var(--text-primary)' }}>
                  {groups.find(g => g.id === selectedGroupId)?.name || 'Unknown Group'}
                </span>
              </div>
            ) : (
              <div className="flex items-center gap-3 px-4 py-3 rounded" style={{ backgroundColor: isDarkMode ? '#FEF3C7' : '#FEF3C7', border: '1px solid #FCD34D' }}>
                <AlertTriangle size={16} className="text-amber-600 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-sm font-medium text-amber-900">Select a group to post to</p>
                  <p className="text-xs text-amber-700">Choose a group from the sidebar to enable posting</p>
              </div>
            </div>
          )}
          </div>

          {/* Action Buttons */}
          <div className="flex items-center justify-between pt-4 mt-6" style={{ borderTop: '1px solid var(--border-neutral)' }}>
            <button
              onClick={handleCancel}
              className="px-3 py-1.5 text-sm transition-colors"
              style={{ color: 'var(--text-secondary)' }}
            >
              Cancel
            </button>
            
            <button
              onClick={handleSavePost}
              disabled={!content.trim() || !selectedGroupId || isGenerating}
              className={`flex items-center gap-2 px-4 py-2 bg-[#336699] hover:bg-[#336699]/80 text-white rounded text-sm font-medium uppercase tracking-[0.5px] transition-colors disabled:cursor-not-allowed ${
                (!content.trim() || !selectedGroupId || isGenerating) ? 'opacity-50' : ''
              }`}
            >
              {isGenerating ? (
                <>
                  <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                  {isEditMode ? 'Updating...' : 'Creating...'}
                </>
              ) : (
                <>
                  <Send size={14} />
                  {isEditMode ? 'Update Post' : 'Create Post'}
                </>
              )}
            </button>
          </div>
          </div>
              {/* End Right Column */}
          </div>
          {/* End Split Layout */}

        </div>
      )}

      {/* Duplicate to Other Groups Modal */}
      {showDuplicateModal && createdPost && (() => {
        const availableGroups = groups.filter(g => g.company_id === selectedCompanyId && g.id !== selectedGroupId)
        // Only include safe groups (non-at-risk) for "Select All"
        const safeGroups = availableGroups.filter(g => {
          const health = calculateGroupHealth(g)
          return health.status !== 'danger'
        })
        const allGroupIds = safeGroups.map(g => g.id)
        const allSelected = selectedGroupIds.length === safeGroups.length && safeGroups.length > 0
        
        return (
        <div className="fixed inset-0 bg-black/85 flex items-center justify-center z-50 p-4">
          <div 
            className="rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col"
            style={{ backgroundColor: 'var(--card-bg)', border: '1px solid var(--border-neutral)' }}
          >
            {/* Header */}
            <div className="p-6 border-b" style={{ borderColor: 'var(--border-neutral)' }}>
                <div className="flex items-center justify-between mb-4">
                <div>
                  <h2 className="text-lg font-semibold mb-1" style={{ color: 'var(--text-primary)' }}>
                    ‚úÖ Post Created Successfully!
                  </h2>
                  <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                    Duplicate this post to other groups?
                  </p>
                </div>
                <button
                  onClick={() => {
                      if (isDuplicating) return // Prevent closing during duplication
                    setShowDuplicateModal(false)
                    setCreatedPost(null)
                      setSelectedGroupIds([])
                  }}
                    disabled={isDuplicating}
                    className="w-8 h-8 rounded flex items-center justify-center transition-colors hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed"
                  style={{ color: 'var(--text-secondary)' }}
                >
                  <X size={18} />
                </button>
              </div>
                
                {/* Select All / None */}
                {availableGroups.length > 0 && (
                  <button
                    onClick={() => {
                      setSelectedGroupIds(allSelected ? [] : allGroupIds)
                    }}
                    className="text-xs font-medium px-3 py-1.5 rounded transition-colors"
                    style={{ 
                      backgroundColor: 'var(--input-bg)',
                      color: '#336699',
                      border: '1px solid var(--border-neutral)'
                    }}
                  >
                    {allSelected ? '‚úì Deselect All' : `Select All Safe Groups (${safeGroups.length})`}
                  </button>
                )}
            </div>

              {/* Warning for 20+ Groups */}
              {selectedGroupIds.length >= 20 && (
                <div className="mx-6 mb-2 p-3 rounded-lg border-2 border-yellow-500/40 bg-yellow-500/10 flex items-start gap-3">
                  <AlertTriangle size={20} className="text-yellow-500 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-sm font-semibold text-yellow-500 mb-1">
                      ‚ö†Ô∏è Posting to {selectedGroupIds.length} Groups at Once
                    </p>
                    <p className="text-xs" style={{ color: 'var(--text-secondary)' }}>
                      Large bulk posts can trigger spam detection on Facebook. Consider splitting into smaller batches (10-15 groups) if possible.
                    </p>
                  </div>
                </div>
              )}

            {/* Groups List - Scrollable */}
              <div className="flex-1 overflow-hidden px-6">
                <List
                  defaultHeight={400}
                  rowCount={availableGroups.length}
                  rowHeight={180}
                  rowProps={{}}
                  rowComponent={({ index, style }) => {
                    const group = availableGroups[index]
                    const health = calculateGroupHealth(group)
                    const isAtRisk = health.status === 'danger'
                    const isCaution = health.status === 'caution'
                    const isSelected = selectedGroupIds.includes(group.id)
                    const isBlocked = isAtRisk // Block at-risk groups
                    
                    return (
                      <div style={style} className="px-0 py-1">
                        <label
                        key={group.id}
                          className={`p-4 rounded-lg transition-all relative ${isBlocked ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer hover:bg-white/5'}`}
                        style={{ 
                          backgroundColor: 'var(--input-bg)',
                            border: `2px dotted ${isSelected ? health.color : (isAtRisk ? '#EF4444' : isCaution ? '#D97706' : 'var(--border-neutral)')}`,
                            display: 'block'
                          }}
                        >
                        <div className="flex items-start gap-4">
                          {/* Checkbox */}
                          <input
                            type="checkbox"
                            checked={isSelected}
                            disabled={isBlocked}
                            onChange={(e) => {
                              if (isBlocked) return
                              if (e.target.checked) {
                                setSelectedGroupIds([...selectedGroupIds, group.id])
                              } else {
                                setSelectedGroupIds(selectedGroupIds.filter(id => id !== group.id))
                              }
                            }}
                            className={`mt-1 w-4 h-4 rounded ${isBlocked ? 'cursor-not-allowed' : 'cursor-pointer'}`}
                            style={{ accentColor: health.color }}
                          />
                          
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                              <span className="text-lg">{health.icon}</span>
                              <h3 className="font-medium text-sm truncate" style={{ color: 'var(--text-primary)' }}>
                                {group.name}
                              </h3>
                              {isBlocked && (
                                <span className="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-red-500/20 text-red-500 border border-red-500/30">
                                  ‚õî Too Risky
                                </span>
                              )}
                            </div>
                            
                            <p className="text-xs mb-2" style={{ color: 'var(--text-secondary)' }}>
                              {health.postsThisWeek}/3 posts this week
                              {health.daysSinceLastPost !== null && ` ¬∑ Last posted ${health.daysSinceLastPost} days ago`}
                              {isBlocked && <span className="text-red-500 font-medium"> ¬∑ Cannot duplicate here</span>}
                            </p>
                            
                            {(isAtRisk || isCaution) && (
                              <div className="flex items-start gap-2 mt-2 p-2 rounded text-xs" style={{ 
                                border: `1px dotted ${health.color}`,
                                backgroundColor: `${health.color}08`,
                                color: health.color
                              }}>
                                <AlertTriangle size={14} className="flex-shrink-0 mt-0.5" />
                                <span>{health.message}</span>
                              </div>
                            )}
                          </div>
                        </div>
                        </label>
                      </div>
                    )
                  }}
                />
              
                {availableGroups.length === 0 && (
                <div className="text-center py-12">
                  <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                    No other groups available for this company
                  </p>
                </div>
              )}
            </div>

            {/* Footer */}
              <div className="p-6 border-t flex items-center gap-3" style={{ borderColor: 'var(--border-neutral)' }}>
              <button
                onClick={() => {
                    if (isDuplicating) return // Prevent closing during duplication
                  setShowDuplicateModal(false)
                  setCreatedPost(null)
                    setSelectedGroupIds([])
                }}
                  disabled={isDuplicating}
                  className="flex-1 px-4 py-2 rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                style={{ 
                  backgroundColor: 'var(--input-bg)',
                  color: 'var(--text-primary)',
                  border: '1px solid var(--border-neutral)'
                }}
              >
                  Skip
                </button>
                
                <button
                  onClick={async () => {
                    if (selectedGroupIds.length === 0 || isDuplicating) return
                    
                    setIsDuplicating(true) // Disable button immediately
                    
                    const count = selectedGroupIds.length
                    let successCount = 0
                    const failedGroups: Array<{ name: string, error: string }> = []
                    const createdPosts: Array<{ id: string, groupName: string }> = []
                    
                    try {
                      // Duplicate to all selected groups (suppress individual toasts)
                      for (const groupId of selectedGroupIds) {
                        const group = groups.find(g => g.id === groupId)
                        const duplicatePost = {
                          ...createdPost,
                          group_id: groupId,
                          created_at: new Date().toISOString()
                        }
                        console.log('üîÑ Duplicating post to group:', group?.name)
                        
                        try {
                          const result = await onPostCreated(duplicatePost, false) // Don't show individual toasts
                          if (result) {
                            successCount++
                            createdPosts.push({ 
                              id: result.id, 
                              groupName: group?.name || 'Unknown Group' 
                            })
                          } else {
                            failedGroups.push({ 
                              name: group?.name || 'Unknown Group', 
                              error: 'Failed to save post' 
                            })
                          }
                        } catch (error) {
                          failedGroups.push({ 
                            name: group?.name || 'Unknown Group', 
                            error: error instanceof Error ? error.message : 'Unknown error' 
                          })
                        }
                      }
                      
                      // Show detailed feedback
                      if (successCount === count) {
                        toast.success(`üéâ Post duplicated to ${count} group${count !== 1 ? 's' : ''} successfully!`)
                        // Start undo timer if 2+ posts were created
                        if (createdPosts.length >= 2) {
                          startUndoTimer(createdPosts)
                        }
                      } else if (successCount > 0) {
                        // Some succeeded, some failed
                        const failedList = failedGroups.map(f => `‚Ä¢ ${f.name}: ${f.error}`).join('\n')
                        toast.error(
                          `‚ö†Ô∏è ${successCount}/${count} posts created.\n\nFailed groups:\n${failedList}`,
                          { duration: 8000 }
                        )
                        // Start undo timer for successfully created posts (if 2+)
                        if (createdPosts.length >= 2) {
                          startUndoTimer(createdPosts)
                        }
                      } else {
                        // All failed
                        const failedList = failedGroups.slice(0, 3).map(f => `‚Ä¢ ${f.name}`).join('\n')
                        const moreCount = failedGroups.length > 3 ? `\n...and ${failedGroups.length - 3} more` : ''
                        toast.error(
                          `‚ùå Failed to duplicate posts:\n${failedList}${moreCount}\n\nPlease try again or check your connection.`,
                          { duration: 6000 }
                        )
                      }
                    } finally {
                      setIsDuplicating(false)
                      setShowDuplicateModal(false)
                      setCreatedPost(null)
                      setSelectedGroupIds([])
                    }
                  }}
                  disabled={selectedGroupIds.length === 0 || isDuplicating}
                  className="flex-1 px-4 py-2 rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  style={{ 
                    backgroundColor: (selectedGroupIds.length > 0 && !isDuplicating) ? '#336699' : 'var(--input-bg)',
                    color: (selectedGroupIds.length > 0 && !isDuplicating) ? '#FFFFFF' : 'var(--text-disabled)',
                    border: (selectedGroupIds.length > 0 && !isDuplicating) ? 'none' : '1px solid var(--border-neutral)'
                  }}
                >
                  {isDuplicating ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                      <span>Duplicating...</span>
                    </>
                  ) : (
                    `Duplicate to ${selectedGroupIds.length} Group${selectedGroupIds.length !== 1 ? 's' : ''}`
                  )}
              </button>
            </div>
          </div>
        </div>
        )
      })()}

      {/* Floating Undo Banner (Bottom of Screen) */}
      {showUndoBanner && recentBulkPosts.length > 0 && (
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 animate-slide-up">
          <div 
            className="rounded-lg shadow-2xl border-2 border-yellow-500/40 p-4 flex items-center gap-4 min-w-[400px]"
            style={{ backgroundColor: 'var(--card-bg)' }}
          >
            <div className="flex-1">
              <p className="text-sm font-semibold mb-1" style={{ color: 'var(--text-primary)' }}>
                ‚ö° {recentBulkPosts.length} posts created
              </p>
              <p className="text-xs" style={{ color: 'var(--text-secondary)' }}>
                Accidentally posted to the wrong groups?
              </p>
            </div>
            
            <button
              onClick={handleBulkUndo}
              disabled={isUndoing}
              className="px-4 py-2 rounded font-medium text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 hover:scale-105"
              style={{ 
                backgroundColor: '#EF4444',
                color: '#FFFFFF'
              }}
            >
              {isUndoing ? (
                <>
                  <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                  <span>Undoing...</span>
                </>
              ) : (
                <>
                  <X size={16} />
                  <span>Undo All</span>
                </>
              )}
            </button>
            
            <button
              onClick={() => {
                setShowUndoBanner(false)
                setRecentBulkPosts([])
                if (undoTimerRef.current) {
                  clearTimeout(undoTimerRef.current)
                }
              }}
              className="w-8 h-8 rounded flex items-center justify-center transition-colors hover:bg-white/10"
              style={{ color: 'var(--text-secondary)' }}
            >
              <X size={18} />
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
